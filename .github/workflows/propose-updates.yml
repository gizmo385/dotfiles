name: Attempts to update dependencies and validate that the upgrade is safe

on:
  workflow_dispatch:
  push:
    branches: ['auto-propose-updates']

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  propose-dotfile-version-updates:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup nix
        uses: cachix/install-nix-action@v27

      - name: Update flake versions
        run: nix flake update

      - name: Diff the updates
        run: git diff

      - name: Attempt to install the updated dotfiles
        run: ./install.sh

      - name: Run the install a second time
        run: ./install.sh
